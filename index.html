<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Food Fridge Dashboard</title>
  <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçΩÔ∏è</text></svg>">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    
    #app-frame {
      width: 100%;
      height: 100%;
      border: none;
    }
    
    /* Loading screen while iframe loads */
    #loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: opacity 0.3s ease;
    }
    
    #loading-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    .loading-logo {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 24px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }
    
    .loading-logo svg {
      width: 45px;
      height: 45px;
      stroke: white;
      fill: none;
    }
    
    .loading-title {
      color: white;
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .loading-subtitle {
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
      margin-bottom: 32px;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255, 255, 255, 0.2);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Error screen */
    #error-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1001;
    }
    
    #error-screen.show {
      display: flex;
    }
    
    .error-icon {
      width: 80px;
      height: 80px;
      background: #fee2e2;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 24px;
    }
    
    .error-icon svg {
      width: 40px;
      height: 40px;
      stroke: #dc2626;
      fill: none;
    }
    
    .error-title {
      color: white;
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .error-message {
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
      text-align: center;
      max-width: 400px;
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loading-screen">
    <div class="loading-logo">
      <svg viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
        <line x1="8" y1="21" x2="16" y2="21"></line>
        <line x1="12" y1="17" x2="12" y2="21"></line>
      </svg>
    </div>
    <div class="loading-title">Food Fridge Dashboard</div>
    <div class="loading-subtitle">Loading your dashboard...</div>
    <div class="loading-spinner"></div>
  </div>
  
  <!-- Error Screen -->
  <div id="error-screen">
    <div class="error-icon">
      <svg viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
    </div>
    <div class="error-title">Dashboard Not Found</div>
    <div class="error-message">No dashboard URL was provided. Please contact your administrator for the correct link.</div>
  </div>
  
  <!-- Apps Script iframe (src set by JavaScript) -->
  <iframe id="app-frame"></iframe>
  
  <script>
    (function() {
      // Get the 'url' parameter from the wrapper URL
      var params = new URLSearchParams(window.location.search);
      var appUrl = params.get('url');
      
      if (!appUrl) {
        // No URL provided - show error
        document.getElementById('error-screen').classList.add('show');
        document.getElementById('loading-screen').classList.add('hidden');
        return;
      }
      
      // Decode if still encoded
      if (appUrl.includes('%3A') || appUrl.includes('%2F')) {
        appUrl = decodeURIComponent(appUrl);
      }
      
      // Store the base script URL (without query params) for navigation
      var baseScriptUrl = appUrl.split('?')[0];
      
      // Extract token from the appUrl if present
      var tokenMatch = appUrl.match(/token=([^&]+)/);
      var registrationToken = tokenMatch ? tokenMatch[1] : '';
      
      // Store token in localStorage for iframe to access
      if (registrationToken) {
        localStorage.setItem('registrationToken', registrationToken);
      }
      
      // ====================================================================
      // STORAGE BRIDGE ‚Äî Persist iframe localStorage in wrapper's stable origin
      // Uses a fixed prefix. No per-client hash ‚Äî the wrapper serves one app.
      // ====================================================================
      var storagePrefix = '_sb_';
      
      // One-time cleanup: migrate any old hash-prefixed keys to the new fixed prefix
      (function() {
        var oldKeys = [];
        for (var i = 0; i < localStorage.length; i++) {
          var k = localStorage.key(i);
          // Old format: _sb_XXXXXXXX_ (8-char hash between underscores)
          if (k && /^_sb_[a-z0-9]{2,8}_/.test(k) && k.indexOf('_sb__') !== 0) {
            oldKeys.push(k);
          }
        }
        oldKeys.forEach(function(oldKey) {
          // Extract the original key after the hash prefix
          var parts = oldKey.match(/^_sb_[a-z0-9]{2,8}_(.+)$/);
          if (parts && parts[1]) {
            var newKey = '_sb_' + parts[1];
            // Only migrate if new key doesn't already exist
            if (!localStorage.getItem(newKey)) {
              localStorage.setItem(newKey, localStorage.getItem(oldKey));
            }
            localStorage.removeItem(oldKey);
          }
        });
      })();
      
      // Collect all prefixed keys for this client from wrapper localStorage
      function getStorageForClient() {
        var data = {};
        for (var i = 0; i < localStorage.length; i++) {
          var key = localStorage.key(i);
          if (key && key.indexOf(storagePrefix) === 0) {
            data[key.substring(storagePrefix.length)] = localStorage.getItem(key);
          }
        }
        return data;
      }
      // ====================================================================
      
      // Build the initial iframe URL
      var iframe = document.getElementById('app-frame');
      iframe.src = appUrl;
      
      // Send the script URL and token to the iframe when it loads
      iframe.onload = function() {
        // Send the base script URL + hydration data to the iframe
        iframe.contentWindow.postMessage({
          type: 'wrapperInit',
          baseScriptUrl: baseScriptUrl,
          registrationToken: registrationToken,
          storageData: getStorageForClient()
        }, '*');
        
        // Hide loading screen
        setTimeout(function() {
          document.getElementById('loading-screen').classList.add('hidden');
        }, 500);
      };
      
      // Listen for messages from the iframe
      window.addEventListener('message', function(event) {
        // Accept messages from Google domains (script.google.com or googleusercontent.com)
        var origin = event.origin || '';
        var isGoogleOrigin = origin.includes('google.com') || origin.includes('googleusercontent.com');
        
        if (!isGoogleOrigin) {
          return;
        }
        
        var data = event.data;
        
        // Ignore non-object messages or messages without type
        if (!data || typeof data !== 'object' || !data.type) {
          return;
        }
        
        // Handle request for script URL from iframe
        if (data.type === 'getScriptUrl') {
          iframe.contentWindow.postMessage({
            type: 'scriptUrl',
            baseScriptUrl: baseScriptUrl
          }, '*');
        }
        
        // Handle request for registration token from iframe
        if (data.type === 'getRegistrationToken') {
          iframe.contentWindow.postMessage({
            type: 'registrationToken',
            token: registrationToken
          }, '*');
        }
        
        // ================================================================
        // STORAGE BRIDGE HANDLERS
        // ================================================================
        
        // Iframe requests hydration ‚Äî send all stored data for this client
        if (data.type === 'requestHydration') {
          iframe.contentWindow.postMessage({
            type: 'storageHydrate',
            data: getStorageForClient()
          }, '*');
        }
        
        // Iframe wrote a key ‚Äî mirror it here with client prefix
        if (data.type === 'storageSet' && typeof data.key === 'string') {
          try {
            localStorage.setItem(storagePrefix + data.key, data.value);
          } catch(e) { /* storage full ‚Äî wrapper has same 5MB limit */ }
        }
        
        // Iframe removed a key ‚Äî remove our prefixed copy
        if (data.type === 'storageRemove' && typeof data.key === 'string') {
          localStorage.removeItem(storagePrefix + data.key);
        }
        
        // Iframe cleared all storage ‚Äî remove all prefixed keys for this client
        if (data.type === 'storageClear') {
          var keysToRemove = [];
          for (var i = 0; i < localStorage.length; i++) {
            var k = localStorage.key(i);
            if (k && k.indexOf(storagePrefix) === 0) {
              keysToRemove.push(k);
            }
          }
          keysToRemove.forEach(function(k) { localStorage.removeItem(k); });
        }
        
        // ================================================================
        // NAVIGATION HANDLER
        // ================================================================
        if (data.type === 'navigate') {
          var page = data.page || 'dashboard';
          var newAppUrl = baseScriptUrl + '?page=' + page;
          
          // Add any additional params
          if (data.params) {
            for (var key in data.params) {
              newAppUrl += '&' + key + '=' + encodeURIComponent(data.params[key]);
            }
          }
          
          // Update wrapper URL for bookmarking
          var newWrapperUrl = window.location.pathname + '?url=' + encodeURIComponent(newAppUrl);
          window.history.replaceState({}, '', newWrapperUrl);
          
          // Show loading screen
          document.getElementById('loading-screen').classList.remove('hidden');
          
          // Navigate iframe to new URL
          iframe.src = newAppUrl;
        }
      });
      
      // Fallback: hide loading screen after 8 seconds regardless
      setTimeout(function() {
        document.getElementById('loading-screen').classList.add('hidden');
      }, 8000);
    })();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Food Fridge Dashboard</title>
  <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçΩÔ∏è</text></svg>">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    
    #app-frame {
      width: 100%;
      height: 100%;
      border: none;
    }
    
    /* Loading screen while iframe loads */
    #loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: opacity 0.3s ease;
    }
    
    #loading-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    .loading-logo {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 24px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }
    
    .loading-logo svg {
      width: 45px;
      height: 45px;
      stroke: white;
      fill: none;
    }
    
    .loading-title {
      color: white;
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .loading-subtitle {
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
      margin-bottom: 32px;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255, 255, 255, 0.2);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Error screen */
    #error-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1001;
    }
    
    #error-screen.show {
      display: flex;
    }
    
    .error-icon {
      width: 80px;
      height: 80px;
      background: #fee2e2;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 24px;
    }
    
    .error-icon svg {
      width: 40px;
      height: 40px;
      stroke: #dc2626;
      fill: none;
    }
    
    .error-title {
      color: white;
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .error-message {
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
      text-align: center;
      max-width: 400px;
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loading-screen">
    <div class="loading-logo">
      <svg viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
        <line x1="8" y1="21" x2="16" y2="21"></line>
        <line x1="12" y1="17" x2="12" y2="21"></line>
      </svg>
    </div>
    <div class="loading-title">Food Fridge Dashboard</div>
    <div class="loading-subtitle">Loading your dashboard...</div>
    <div class="loading-spinner"></div>
  </div>
  
  <!-- Error Screen -->
  <div id="error-screen">
    <div class="error-icon">
      <svg viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
    </div>
    <div class="error-title">Dashboard Not Found</div>
    <div class="error-message">No dashboard URL was provided. Please contact your administrator for the correct link.</div>
  </div>
  
  <!-- Apps Script iframe (src set by JavaScript) -->
  <iframe id="app-frame"></iframe>
  
  <script>
    (function() {
      // DEBUG: Show raw URL info
      alert('DEBUG 1 - Full wrapper URL:\n' + window.location.href);
      
      // Get the 'url' parameter from the wrapper URL
      var params = new URLSearchParams(window.location.search);
      var appUrl = params.get('url');
      
      // DEBUG: Show what params.get returned
      alert('DEBUG 2 - appUrl from params.get("url"):\n' + appUrl);
      
      if (!appUrl) {
        // No URL provided - show error
        document.getElementById('error-screen').classList.add('show');
        document.getElementById('loading-screen').classList.add('hidden');
        return;
      }
      
      // DEBUG: Check if still encoded
      if (appUrl.includes('%3A') || appUrl.includes('%2F')) {
        alert('DEBUG 3 - appUrl is STILL ENCODED, decoding again...');
        appUrl = decodeURIComponent(appUrl);
        alert('DEBUG 4 - appUrl after decode:\n' + appUrl);
      } else {
        alert('DEBUG 3 - appUrl is properly decoded');
      }
      
      // Store the base script URL (without query params) for navigation
      var baseScriptUrl = appUrl.split('?')[0];
      
      // Build the initial iframe URL
      var iframe = document.getElementById('app-frame');
      iframe.src = appUrl;
      
      // Send the script URL to the iframe when it loads
      iframe.onload = function() {
        // Send the base script URL to the iframe
        iframe.contentWindow.postMessage({
          type: 'wrapperInit',
          baseScriptUrl: baseScriptUrl
        }, '*');
        
        // Hide loading screen
        setTimeout(function() {
          document.getElementById('loading-screen').classList.add('hidden');
        }, 500);
      };
      
      // Listen for navigation messages from the iframe
      window.addEventListener('message', function(event) {
        // Accept messages from Google domains (script.google.com or googleusercontent.com)
        var origin = event.origin || '';
        var isGoogleOrigin = origin.includes('google.com') || origin.includes('googleusercontent.com');
        
        if (!isGoogleOrigin) {
          return;
        }
        
        var data = event.data;
        
        // Ignore non-object messages or messages without type
        if (!data || typeof data !== 'object' || !data.type) {
          return;
        }
        
        // Handle request for script URL from iframe
        if (data.type === 'getScriptUrl') {
          iframe.contentWindow.postMessage({
            type: 'scriptUrl',
            baseScriptUrl: baseScriptUrl
          }, '*');
        }
        
        // Handle navigation request from iframe
        if (data.type === 'navigate') {
          var page = data.page || 'dashboard';
          var newAppUrl = baseScriptUrl + '?page=' + page;
          
          // Add any additional params
          if (data.params) {
            for (var key in data.params) {
              newAppUrl += '&' + key + '=' + encodeURIComponent(data.params[key]);
            }
          }
          
          // Update wrapper URL for bookmarking
          var newWrapperUrl = window.location.pathname + '?url=' + encodeURIComponent(newAppUrl);
          window.history.replaceState({}, '', newWrapperUrl);
          
          // Show loading screen
          document.getElementById('loading-screen').classList.remove('hidden');
          
          // Navigate iframe to new URL
          iframe.src = newAppUrl;
        }
      });
      
      // Fallback: hide loading screen after 8 seconds regardless
      setTimeout(function() {
        document.getElementById('loading-screen').classList.add('hidden');
      }, 8000);
    })();
  </script>
</body>
</html>
